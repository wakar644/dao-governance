services:
  # Hardhat blockchain node
  blockchain:
    build: .
    container_name: dao-blockchain
    command: npx hardhat node --hostname 0.0.0.0
    ports:
      - "8545:8545"
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"id\":1}' http://localhost:8545 || exit 1" ]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 20s
    networks:
      - dao-network

  # Contract deployer (runs once)
  deployer:
    build: .
    container_name: dao-deployer
    command: >
      sh -c "
        echo 'Waiting for blockchain...' &&
        sleep 10 &&
        npx hardhat run scripts/deployV2.js --network localhost &&
        echo 'Contracts deployed!'
      "
    environment:
      - HARDHAT_NETWORK=localhost
    depends_on:
      blockchain:
        condition: service_healthy
    networks:
      - dao-network

  # Frontend server
  frontend:
    build: .
    container_name: dao-frontend
    command: serve -s frontend -l 3000
    ports:
      - "3000:3000"
    depends_on:
      deployer:
        condition: service_completed_successfully
    networks:
      - dao-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # ngrok tunnel (optional - for public access)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: dao-ngrok
    command: http frontend:3000 --log=stdout
    ports:
      - "4040:4040" # ngrok web interface
    depends_on:
      frontend:
        condition: service_healthy
    networks:
      - dao-network
    profiles:
      - public # Only starts with: docker compose --profile public up

networks:
  dao-network:
    driver: bridge
